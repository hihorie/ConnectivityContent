<div class="large-6 large-centered medium-10 medium-centered columns simple-content">
    <h1>EPC Login</h1>
    <p class="announce">
        Please enter your Expedia Partner Central (EPC) login details below.
    </p>
    <form id="loginform" class="announce" style="margin-bottom: 200px;" onsubmit="login(this); return false;">
        <div class="formline"><span class="right-align">Username: </span><input id="username" placeholder=""/></div>
        <div class="formline"><span class="right-align">Password: </span><input id="password" type="password"
                                                                                placeholder=""/></div>
        <div id="result" class="formline center"></div>
        <div class="formline"><input class="submit" type="submit" value="Login"/></div>
    </form>
    <div class="loader" style="display: none;">
        <div class="background">&nbsp;</div>
        <svg class="circular">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
        </svg>
    </div>
</div>
<script src="/test-properties/urls.js"></script>
<script src="/js/jwtAuthentication.js"></script>
<!--[if lte IE 9]>
<script src="/js/base64.js"></script>
<!--<![endif]-->
<script>
    function loadStart() {
        $(".loader").show();
        $("#loginform input").attr("disabled", true).addClass("disabled");
    }

    function loadEnd() {
        $(".loader").hide();
        $("#result").removeClass("error");
        $("#loginform input").removeAttr("disabled").removeClass("disabled");
    }

    function login(form) {
        var username = $(form).find("#username").val();
        var password = $(form).find("#password").val();

        ga('send', 'event', 'login', 'request');
        $.ajax({
            method: "POST",
            url: hotelAssignmentServiceUrls.login(),
            xhrFields: {
                withCredentials: false,
                XDomainRequest: true
            },
            beforeSend: function(xhr) {
                if (username) {
                    xhr.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + password));
                }
                loadStart();
            }
        }).done(function(data, textStatus, jqxhr) {
            loadEnd();
            ga('set', 'dimension0', username);
            ga('send', 'event', 'login', 'success', username);
            localStorage.setItem("AuthToken", jqxhr.getResponseHeader('X-Auth-Token'));
            try {
                if (JSON.parse(data).admin) {
                    window.location.href = "/test-properties/schedules-admin"
                } else {
                    window.location.href = "/test-properties/schedules";
                }
            } catch (e) {
                window.location.href = "/test-properties/schedules";
            }
        }).fail(function(jqxhr) {
            loadEnd();
            ga('send', 'event', 'login', 'failure', jqxhr.statusText);
            if (jqxhr.status == 403 || jqxhr.status == 401) {
                if (username.match(/^eqc/i) != null) {
                    $("#result").addClass("error").html("API/EQC credentials can not be used to access this feature.  Please use your EPC (e.g. SYS_) credentials.");
                } else {
                    $("#result").addClass("error").html("Incorrect username or password.");
                }
            } else {
                $("#result").addClass("error").html("Request failed: " + jqxhr.status + ": " + jqxhr.statusText);
            }
        });
    }

    if (localStorage.getItem("AuthToken") !== null) {
        window.location.href = "/test-properties/schedules";
    }

    $(document).ready(function() {
        ga('send', 'event', 'login', 'access');
    });

</script>